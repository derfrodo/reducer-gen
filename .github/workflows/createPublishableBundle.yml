# This is a basic workflow that is manually triggered
name: Create Publishable Bundle

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  nodeVersion: 16.x
  packageName: "@derfrodo/reducer-gen"
  artefactName: "derfrodo_reducer-gen"

jobs:

  readver:
    # uses: derfrodok/reducer-gen/.github/workflows/readPackageVersion.yml@main
    uses: ./.github/workflows/templateReadPackageVersion.yml
    with:
      packageName: "@derfrodo/reducer-gen"
    secrets:
      testsecret: demosecret

  prepare: 
    runs-on: ubuntu-latest
    name: "Prepare build settings"
    needs: readver
    outputs:
      packageVersion: ${{ needs.readver.outputs.packageVersion  }}
      artefactName: ${{ env.artefactName }}-${{ needs.readver.outputs.packageVersion }}-run-${{ github.run_id }}
    steps:
    - name: Read Deployed Versions
      run: |
        echo "Version has been published: $IS_PUBLISHED"

  build:
    needs: 
    - prepare
    uses: ./.github/workflows/templateCreateBundle.yml
    with:
      artefactName: ${{ needs.prepare.outputs.artefactName }}
      # nodeVersion: ${{ matrix.node-version }}
      nodeVersions: "[\"14.x\", \"16.x\"]"
      include: "[{\"nodeVersion\":\"14.x\", \"artefactName\":\"${{ env.artefactName }}-${{ needs.readver.outputs.packageVersion }}-14.x-run-${{ github.run_id }}\"}]"
      
