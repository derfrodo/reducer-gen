# This is a basic workflow that is manually triggered
name: Build and publish Beta

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  nodeVersion: 16.x
  packageName: "@derfrodo/reducer-gen"
  artefactName: "derfrodo_reducer-gen"

jobs:

  readver:
    # uses: derfrodok/reducer-gen/.github/workflows/readPackageVersion.yml@main
    uses: ./.github/workflows/templateReadPackageVersion.yml
    env: 
      packageName: ${{ env.packageName }}
    with:
      username: demouser
    secrets:
      testsecret: demosecret

  prepare: 
    runs-on: ubuntu-latest
    name: "Prepare run"
    needs: readver
    outputs:
      packageVersion: ${{ needs.readver.outputs.packageVersion  }}
      packageVersionIsPublished: ${{ steps.evaluate_package_version.outputs.versionPublished  }}
    steps:
    - uses: actions/checkout@v2
    - name: Using Node.js ${{ env.nodeVersion }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.nodeVersion }}
    - name: Read Deployed Versions
      run: |
        # see also stackoverflow.com/questions/19345872/how-to-remove-a-newline-from-a-string-in-bash
        PACKAGE_VERSION=${{ needs.readver.outputs.packageVersion }}
        echo "Search for $PACKAGE_VERSION in published versions"
        PACKAGE_VERSIONS=$(npm view ${{ env.packageName }} versions --json)
        SCRIPT="const index=${PACKAGE_VERSIONS}.indexOf(\"${PACKAGE_VERSION}\"); console.log(index >= 0);"
        echo $SCRIPT > script.js

        IS_PUBLISHED=$(node script.js)

        echo "Version has been published: $IS_PUBLISHED"
        echo "::set-output name=versionPublished::$IS_PUBLISHED"
      id: evaluate_package_version

  not_deployed: 
    name: "Version not deployed yet"
    runs-on: ubuntu-latest
    needs: 
    - prepare
    #docs.github.com/en/actions/learn-github-actions/expressions
    if: ${{ needs.prepare.outputs.packageVersionIsPublished == 'false' }}
    steps:
    - name: Info
      run: |
        echo "Version ${{ needs.prepare.outputs.packageVersion }} has not been deployed to npm yet."
  
  already_deployed: 
    runs-on: ubuntu-latest
    name: "Version already deployed"
    needs: 
    - prepare
    #docs.github.com/en/actions/learn-github-actions/expressions
    if: ${{ needs.prepare.outputs.packageVersionIsPublished == 'true' }}
    steps:
    - name: Info
      run: |
        echo "Version ${{ needs.prepare.outputs.packageVersion }} has been deployed to npm already."

  build:
    if: ${{ needs.prepare.outputs.packageVersionIsPublished == 'false' }}
    runs-on: ubuntu-latest
    name: "Build package"
    needs: 
    - prepare
    steps:
    - uses: actions/checkout@v2
    - name: Using Node.js ${{ env.nodeVersion }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.nodeVersion }}
    
    - name: perform installation (npm ci)
      shell: bash
      run: cd lib && npm ci
    
    - name: perform unittests
      shell: bash
      run: |
        cd lib
        npm test
    
    - name: build bundle (npm ci)
      shell: bash
      run: cd lib && npm run build
      
    - name: prepare package for publishing
      shell: bash
      run: |
        cd lib
        npm run prepareForPublish

    - name: Archive code 
      uses: actions/upload-artifact@v2
      with:
        name: ${{ env.artefactName }}-${{ needs.prepare.outputs.packageVersion }}-run-${{ github.run_id }}
        path: "lib"

  deploy:
    runs-on: ubuntu-latest
    needs: 
    - build
    - prepare
    name: "Deploy package as beta"
    environment: beta
    
    steps:
    - uses: actions/checkout@v2
    - name: Using Node.js ${{ env.nodeVersion }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ env.nodeVersion }}

    - name: Download artifact from build job
      uses: actions/download-artifact@v3
      id: downloadArtefact
      with:
        name: ${{ env.artefactName }}-${{ needs.prepare.outputs.packageVersion }}-run-${{ github.run_id }}
        path: ${{ env.packageName }}-${{ needs.prepare.outputs.packageVersion }}-artefact

    - name: What has been downloaded
      working-directory: ${{ steps.downloadArtefact.outputs.download-path }}
      run: |
        echo ${{ steps.downloadArtefact.outputs.download-path }}
        ls -R

    - name: Deploy to npm js as beta version
      working-directory: ${{ steps.downloadArtefact.outputs.download-path }}
      env:
        NPM_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
      run: |
        touch .npmrc
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc
        npm publish --access public --tag beta

